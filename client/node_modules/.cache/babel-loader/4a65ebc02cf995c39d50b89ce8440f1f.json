{"ast":null,"code":"\"use strict\";\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.SCHEMA_QUERY = exports.EngineSchemaProvider = void 0;\n\nconst graphql_tag_1 = __importDefault(require(\"graphql-tag\"));\n\nconst graphql_1 = require(\"graphql\");\n\nconst engine_1 = require(\"../../engine\");\n\nconst config_1 = require(\"../../config\");\n\nconst utilities_1 = require(\"../../utilities\");\n\nclass EngineSchemaProvider {\n  constructor(config, clientIdentity) {\n    this.config = config;\n    this.clientIdentity = clientIdentity;\n  }\n\n  async resolveSchema(override) {\n    if (this.schema && (!override || !override.force)) return this.schema;\n    const {\n      engine,\n      client\n    } = this.config;\n\n    if (!this.config.graph) {\n      throw new Error(`No graph ID found for client. Please specify a graph ID via the config or the --graph flag`);\n    }\n\n    if (!this.client) {\n      if (!engine.apiKey) {\n        throw new Error(`No API key found. Please set ${config_1.keyEnvVar} or use --key`);\n      }\n\n      this.client = new engine_1.ApolloEngineClient(engine.apiKey, engine.endpoint, this.clientIdentity);\n    }\n\n    const {\n      data,\n      errors\n    } = await this.client.execute({\n      query: exports.SCHEMA_QUERY,\n      variables: {\n        id: this.config.graph,\n        tag: override && override.tag ? override.tag : this.config.variant\n      }\n    });\n\n    if (errors) {\n      throw new Error(errors.map(({\n        message\n      }) => message).join(\"\\n\"));\n    }\n\n    if (!(data && data.service && data.service.__typename === \"Service\")) {\n      throw new Error(`Unable to get schema from the Apollo registry for graph ${this.config.graph}`);\n    }\n\n    this.schema = (0, graphql_1.buildClientSchema)(data.service.schema);\n    return this.schema;\n  }\n\n  onSchemaChange(_handler) {\n    throw new Error(\"Polling of Apollo not implemented yet\");\n    return () => {};\n  }\n\n  async resolveFederatedServiceSDL() {\n    utilities_1.Debug.error(\"Cannot resolve a federated service's SDL from Apollo. Use an endpoint or a file instead\");\n    return;\n  }\n\n}\n\nexports.EngineSchemaProvider = EngineSchemaProvider;\nexports.SCHEMA_QUERY = (0, graphql_tag_1.default)`\n  query GetSchemaByTag($tag: String!, $id: ID!) {\n    service(id: $id) {\n      ... on Service {\n        __typename\n        schema(tag: $tag) {\n          hash\n          __schema: introspection {\n            queryType {\n              name\n            }\n            mutationType {\n              name\n            }\n            subscriptionType {\n              name\n            }\n            types(filter: { includeBuiltInTypes: true }) {\n              ...IntrospectionFullType\n            }\n            directives {\n              name\n              description\n              locations\n              args {\n                ...IntrospectionInputValue\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n\n  fragment IntrospectionFullType on IntrospectionType {\n    kind\n    name\n    description\n    fields {\n      name\n      description\n      args {\n        ...IntrospectionInputValue\n      }\n      type {\n        ...IntrospectionTypeRef\n      }\n      isDeprecated\n      deprecationReason\n    }\n    inputFields {\n      ...IntrospectionInputValue\n    }\n    interfaces {\n      ...IntrospectionTypeRef\n    }\n    enumValues(includeDeprecated: true) {\n      name\n      description\n      isDeprecated\n      deprecationReason\n    }\n    possibleTypes {\n      ...IntrospectionTypeRef\n    }\n  }\n\n  fragment IntrospectionInputValue on IntrospectionInputValue {\n    name\n    description\n    type {\n      ...IntrospectionTypeRef\n    }\n    defaultValue\n  }\n\n  fragment IntrospectionTypeRef on IntrospectionType {\n    kind\n    name\n    ofType {\n      kind\n      name\n      ofType {\n        kind\n        name\n        ofType {\n          kind\n          name\n          ofType {\n            kind\n            name\n            ofType {\n              kind\n              name\n              ofType {\n                kind\n                name\n                ofType {\n                  kind\n                  name\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n`;","map":{"version":3,"sources":["../../../src/providers/schema/engine.ts"],"names":[],"mappings":";;;;;;;;;;;;;AAEA,MAAA,aAAA,GAAA,eAAA,CAAA,OAAA,CAAA,aAAA,CAAA,CAAA;;AACA,MAAA,SAAA,GAAA,OAAA,CAAA,SAAA,CAAA;;AACA,MAAA,QAAA,GAAA,OAAA,CAAA,cAAA,CAAA;;AACA,MAAA,QAAA,GAAA,OAAA,CAAA,cAAA,CAAA;;AASA,MAAA,WAAA,GAAA,OAAA,CAAA,iBAAA,CAAA;;AAEA,MAAa,oBAAb,CAAiC;EAI/B,WAAA,CACU,MADV,EAEU,cAFV,EAEyC;IAD/B,KAAA,MAAA,GAAA,MAAA;IACA,KAAA,cAAA,GAAA,cAAA;EACN;;EAEe,MAAb,aAAa,CAAC,QAAD,EAA8B;IAC/C,IAAI,KAAK,MAAL,KAAgB,CAAC,QAAD,IAAa,CAAC,QAAQ,CAAC,KAAvC,CAAJ,EAAmD,OAAO,KAAK,MAAZ;IACnD,MAAM;MAAE,MAAF;MAAU;IAAV,IAAqB,KAAK,MAAhC;;IAEA,IAAI,CAAC,KAAK,MAAL,CAAY,KAAjB,EAAwB;MACtB,MAAM,IAAI,KAAJ,CACJ,4FADI,CAAN;IAGD;;IAGD,IAAI,CAAC,KAAK,MAAV,EAAkB;MAChB,IAAI,CAAC,MAAM,CAAC,MAAZ,EAAoB;QAClB,MAAM,IAAI,KAAJ,CACJ,gCAAgC,QAAA,CAAA,SAAS,eADrC,CAAN;MAGD;;MACD,KAAK,MAAL,GAAc,IAAI,QAAA,CAAA,kBAAJ,CACZ,MAAM,CAAC,MADK,EAEZ,MAAM,CAAC,QAFK,EAGZ,KAAK,cAHO,CAAd;IAKD;;IAED,MAAM;MAAE,IAAF;MAAQ;IAAR,IAAmB,MAAM,KAAK,MAAL,CAAY,OAAZ,CAAoC;MACjE,KAAK,EAAE,OAAA,CAAA,YAD0D;MAEjE,SAAS,EAAE;QACT,EAAE,EAAE,KAAK,MAAL,CAAY,KADP;QAET,GAAG,EAAE,QAAQ,IAAI,QAAQ,CAAC,GAArB,GAA2B,QAAQ,CAAC,GAApC,GAA0C,KAAK,MAAL,CAAY;MAFlD;IAFsD,CAApC,CAA/B;;IAOA,IAAI,MAAJ,EAAY;MAEV,MAAM,IAAI,KAAJ,CAAU,MAAM,CAAC,GAAP,CAAW,CAAC;QAAE;MAAF,CAAD,KAAwB,OAAnC,EAA4C,IAA5C,CAAiD,IAAjD,CAAV,CAAN;IACD;;IAED,IAAI,EAAE,IAAI,IAAI,IAAI,CAAC,OAAb,IAAwB,IAAI,CAAC,OAAL,CAAa,UAAb,KAA4B,SAAtD,CAAJ,EAAsE;MACpE,MAAM,IAAI,KAAJ,CACJ,2DAA2D,KAAK,MAAL,CAAY,KAAK,EADxE,CAAN;IAGD;;IAID,KAAK,MAAL,GAAc,CAAA,GAAA,SAAA,CAAA,iBAAA,EAAkB,IAAI,CAAC,OAAL,CAAa,MAA/B,CAAd;IACA,OAAO,KAAK,MAAZ;EACD;;EAED,cAAc,CACZ,QADY,EACgC;IAE5C,MAAM,IAAI,KAAJ,CAAU,uCAAV,CAAN;IACA,OAAO,MAAK,CAAG,CAAf;EACD;;EAE+B,MAA1B,0BAA0B,GAAA;IAC9B,WAAA,CAAA,KAAA,CAAM,KAAN,CACE,yFADF;IAGA;EACD;;AArE8B;;AAAjC,OAAA,CAAA,oBAAA,GAAA,oBAAA;AAwEa,OAAA,CAAA,YAAA,GAAe,CAAA,GAAA,aAAA,CAAA,OAAA,CAAG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA4G9B,CA5GY","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.SCHEMA_QUERY = exports.EngineSchemaProvider = void 0;\nconst graphql_tag_1 = __importDefault(require(\"graphql-tag\"));\nconst graphql_1 = require(\"graphql\");\nconst engine_1 = require(\"../../engine\");\nconst config_1 = require(\"../../config\");\nconst utilities_1 = require(\"../../utilities\");\nclass EngineSchemaProvider {\n    constructor(config, clientIdentity) {\n        this.config = config;\n        this.clientIdentity = clientIdentity;\n    }\n    async resolveSchema(override) {\n        if (this.schema && (!override || !override.force))\n            return this.schema;\n        const { engine, client } = this.config;\n        if (!this.config.graph) {\n            throw new Error(`No graph ID found for client. Please specify a graph ID via the config or the --graph flag`);\n        }\n        if (!this.client) {\n            if (!engine.apiKey) {\n                throw new Error(`No API key found. Please set ${config_1.keyEnvVar} or use --key`);\n            }\n            this.client = new engine_1.ApolloEngineClient(engine.apiKey, engine.endpoint, this.clientIdentity);\n        }\n        const { data, errors } = await this.client.execute({\n            query: exports.SCHEMA_QUERY,\n            variables: {\n                id: this.config.graph,\n                tag: override && override.tag ? override.tag : this.config.variant,\n            },\n        });\n        if (errors) {\n            throw new Error(errors.map(({ message }) => message).join(\"\\n\"));\n        }\n        if (!(data && data.service && data.service.__typename === \"Service\")) {\n            throw new Error(`Unable to get schema from the Apollo registry for graph ${this.config.graph}`);\n        }\n        this.schema = (0, graphql_1.buildClientSchema)(data.service.schema);\n        return this.schema;\n    }\n    onSchemaChange(_handler) {\n        throw new Error(\"Polling of Apollo not implemented yet\");\n        return () => { };\n    }\n    async resolveFederatedServiceSDL() {\n        utilities_1.Debug.error(\"Cannot resolve a federated service's SDL from Apollo. Use an endpoint or a file instead\");\n        return;\n    }\n}\nexports.EngineSchemaProvider = EngineSchemaProvider;\nexports.SCHEMA_QUERY = (0, graphql_tag_1.default) `\n  query GetSchemaByTag($tag: String!, $id: ID!) {\n    service(id: $id) {\n      ... on Service {\n        __typename\n        schema(tag: $tag) {\n          hash\n          __schema: introspection {\n            queryType {\n              name\n            }\n            mutationType {\n              name\n            }\n            subscriptionType {\n              name\n            }\n            types(filter: { includeBuiltInTypes: true }) {\n              ...IntrospectionFullType\n            }\n            directives {\n              name\n              description\n              locations\n              args {\n                ...IntrospectionInputValue\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n\n  fragment IntrospectionFullType on IntrospectionType {\n    kind\n    name\n    description\n    fields {\n      name\n      description\n      args {\n        ...IntrospectionInputValue\n      }\n      type {\n        ...IntrospectionTypeRef\n      }\n      isDeprecated\n      deprecationReason\n    }\n    inputFields {\n      ...IntrospectionInputValue\n    }\n    interfaces {\n      ...IntrospectionTypeRef\n    }\n    enumValues(includeDeprecated: true) {\n      name\n      description\n      isDeprecated\n      deprecationReason\n    }\n    possibleTypes {\n      ...IntrospectionTypeRef\n    }\n  }\n\n  fragment IntrospectionInputValue on IntrospectionInputValue {\n    name\n    description\n    type {\n      ...IntrospectionTypeRef\n    }\n    defaultValue\n  }\n\n  fragment IntrospectionTypeRef on IntrospectionType {\n    kind\n    name\n    ofType {\n      kind\n      name\n      ofType {\n        kind\n        name\n        ofType {\n          kind\n          name\n          ofType {\n            kind\n            name\n            ofType {\n              kind\n              name\n              ofType {\n                kind\n                name\n                ofType {\n                  kind\n                  name\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n`;\n//# sourceMappingURL=engine.js.map"]},"metadata":{},"sourceType":"script"}