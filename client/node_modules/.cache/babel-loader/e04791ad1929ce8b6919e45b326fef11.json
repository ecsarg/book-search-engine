{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar _detectNode = _interopRequireDefault(require(\"detect-node\"));\n\nvar _globalthis = _interopRequireDefault(require(\"globalthis\"));\n\nvar _jsonStringifySafe = _interopRequireDefault(require(\"json-stringify-safe\"));\n\nvar _sprintfJs = require(\"sprintf-js\");\n\nvar _constants = require(\"../constants\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nfunction _extends() {\n  _extends = Object.assign || function (target) {\n    for (var i = 1; i < arguments.length; i++) {\n      var source = arguments[i];\n\n      for (var key in source) {\n        if (Object.prototype.hasOwnProperty.call(source, key)) {\n          target[key] = source[key];\n        }\n      }\n    }\n\n    return target;\n  };\n\n  return _extends.apply(this, arguments);\n}\n\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    if (enumerableOnly) symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    });\n    keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n\n    if (i % 2) {\n      ownKeys(Object(source), true).forEach(function (key) {\n        _defineProperty(target, key, source[key]);\n      });\n    } else if (Object.getOwnPropertyDescriptors) {\n      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));\n    } else {\n      ownKeys(Object(source)).forEach(function (key) {\n        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n      });\n    }\n  }\n\n  return target;\n}\n\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nconst globalThis = (0, _globalthis.default)();\nlet domain;\n\nif (_detectNode.default) {\n  // eslint-disable-next-line global-require\n  domain = require('domain');\n}\n\nconst getParentDomainContext = () => {\n  if (!domain) {\n    return {};\n  }\n\n  const parentRoarrContexts = [];\n  let currentDomain = process.domain; // $FlowFixMe\n\n  if (!currentDomain || !currentDomain.parentDomain) {\n    return {};\n  }\n\n  while (currentDomain && currentDomain.parentDomain) {\n    currentDomain = currentDomain.parentDomain;\n\n    if (currentDomain.roarr && currentDomain.roarr.context) {\n      parentRoarrContexts.push(currentDomain.roarr.context);\n    }\n  }\n\n  let domainContext = {};\n\n  for (const parentRoarrContext of parentRoarrContexts) {\n    domainContext = _objectSpread(_objectSpread({}, domainContext), parentRoarrContext);\n  }\n\n  return domainContext;\n};\n\nconst getFirstParentDomainContext = () => {\n  if (!domain) {\n    return {};\n  }\n\n  let currentDomain = process.domain; // $FlowFixMe\n\n  if (currentDomain && currentDomain.roarr && currentDomain.roarr.context) {\n    return currentDomain.roarr.context;\n  } // $FlowFixMe\n\n\n  if (!currentDomain || !currentDomain.parentDomain) {\n    return {};\n  }\n\n  while (currentDomain && currentDomain.parentDomain) {\n    currentDomain = currentDomain.parentDomain;\n\n    if (currentDomain.roarr && currentDomain.roarr.context) {\n      return currentDomain.roarr.context;\n    }\n  }\n\n  return {};\n};\n\nconst createLogger = (onMessage, parentContext) => {\n  // eslint-disable-next-line id-length, unicorn/prevent-abbreviations\n  const log = (a, b, c, d, e, f, g, h, i, k) => {\n    const time = Date.now();\n    const sequence = globalThis.ROARR.sequence++;\n    let context;\n    let message;\n\n    if (typeof a === 'string') {\n      context = _objectSpread(_objectSpread({}, getFirstParentDomainContext()), parentContext || {}); // eslint-disable-next-line id-length, object-property-newline\n\n      const args = _extends({}, {\n        a,\n        b,\n        c,\n        d,\n        e,\n        f,\n        g,\n        h,\n        i,\n        k\n      });\n\n      const values = Object.keys(args).map(key => {\n        return args[key];\n      }); // eslint-disable-next-line unicorn/no-reduce\n\n      const hasOnlyOneParameterValued = 1 === values.reduce((accumulator, value) => {\n        // eslint-disable-next-line no-return-assign, no-param-reassign\n        return accumulator += typeof value === 'undefined' ? 0 : 1;\n      }, 0);\n      message = hasOnlyOneParameterValued ? (0, _sprintfJs.sprintf)('%s', a) : (0, _sprintfJs.sprintf)(a, b, c, d, e, f, g, h, i, k);\n    } else {\n      if (typeof b !== 'string') {\n        throw new TypeError('Message must be a string.');\n      }\n\n      context = JSON.parse((0, _jsonStringifySafe.default)(_objectSpread(_objectSpread(_objectSpread({}, getFirstParentDomainContext()), parentContext || {}), a)));\n      message = (0, _sprintfJs.sprintf)(b, c, d, e, f, g, h, i, k);\n    }\n\n    onMessage({\n      context,\n      message,\n      sequence,\n      time,\n      version: '1.0.0'\n    });\n  };\n\n  log.child = context => {\n    if (typeof context === 'function') {\n      return createLogger(message => {\n        if (typeof context !== 'function') {\n          throw new TypeError('Unexpected state.');\n        }\n\n        onMessage(context(message));\n      }, parentContext);\n    }\n\n    return createLogger(onMessage, _objectSpread(_objectSpread(_objectSpread({}, getFirstParentDomainContext()), parentContext), context));\n  };\n\n  log.getContext = () => {\n    return _objectSpread(_objectSpread({}, getFirstParentDomainContext()), parentContext || {});\n  };\n\n  log.adopt = async (routine, context) => {\n    if (!domain) {\n      return routine();\n    }\n\n    const adoptedDomain = domain.create();\n    return adoptedDomain.run(() => {\n      // $FlowFixMe\n      adoptedDomain.roarr = {\n        context: _objectSpread(_objectSpread({}, getParentDomainContext()), context)\n      };\n      return routine();\n    });\n  };\n\n  for (const logLevel of Object.keys(_constants.logLevels)) {\n    // eslint-disable-next-line id-length, unicorn/prevent-abbreviations\n    log[logLevel] = (a, b, c, d, e, f, g, h, i, k) => {\n      return log.child({\n        logLevel: _constants.logLevels[logLevel]\n      })(a, b, c, d, e, f, g, h, i, k);\n    };\n  } // @see https://github.com/facebook/flow/issues/6705\n  // $FlowFixMe\n\n\n  return log;\n};\n\nvar _default = createLogger;\nexports.default = _default;","map":{"version":3,"sources":["../../src/factories/createLogger.js"],"names":["globalThis","environmentIsNode","domain","require","getParentDomainContext","parentRoarrContexts","currentDomain","process","domainContext","getFirstParentDomainContext","createLogger","log","time","Date","sequence","context","parentContext","args","k","values","key","hasOnlyOneParameterValued","accumulator","message","JSON","onMessage","version","routine","adoptedDomain","Object","logLevels","logLevel"],"mappings":"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","sourcesContent":["// @flow\n\nimport environmentIsNode from 'detect-node';\nimport createGlobalThis from 'globalthis';\nimport stringify from 'json-stringify-safe';\nimport {\n  sprintf,\n} from 'sprintf-js';\nimport {\n  logLevels,\n} from '../constants';\nimport type {\n  LoggerType,\n  MessageContextType,\n  MessageEventHandlerType,\n  TranslateMessageFunctionType,\n} from '../types';\n\nconst globalThis = createGlobalThis();\n\nlet domain;\n\nif (environmentIsNode) {\n  // eslint-disable-next-line global-require\n  domain = require('domain');\n}\n\nconst getParentDomainContext = () => {\n  if (!domain) {\n    return {};\n  }\n\n  const parentRoarrContexts = [];\n\n  let currentDomain = process.domain;\n\n  // $FlowFixMe\n  if (!currentDomain || !currentDomain.parentDomain) {\n    return {};\n  }\n\n  while (currentDomain && currentDomain.parentDomain) {\n    currentDomain = currentDomain.parentDomain;\n\n    if (currentDomain.roarr && currentDomain.roarr.context) {\n      parentRoarrContexts.push(currentDomain.roarr.context);\n    }\n  }\n\n  let domainContext = {};\n\n  for (const parentRoarrContext of parentRoarrContexts) {\n    domainContext = {\n      ...domainContext,\n      ...parentRoarrContext,\n    };\n  }\n\n  return domainContext;\n};\n\nconst getFirstParentDomainContext = () => {\n  if (!domain) {\n    return {};\n  }\n\n  let currentDomain = process.domain;\n\n  // $FlowFixMe\n  if (currentDomain && currentDomain.roarr && currentDomain.roarr.context) {\n    return currentDomain.roarr.context;\n  }\n\n  // $FlowFixMe\n  if (!currentDomain || !currentDomain.parentDomain) {\n    return {};\n  }\n\n  while (currentDomain && currentDomain.parentDomain) {\n    currentDomain = currentDomain.parentDomain;\n\n    if (currentDomain.roarr && currentDomain.roarr.context) {\n      return currentDomain.roarr.context;\n    }\n  }\n\n  return {};\n};\n\nconst createLogger = (onMessage: MessageEventHandlerType, parentContext?: MessageContextType): LoggerType => {\n  // eslint-disable-next-line id-length, unicorn/prevent-abbreviations\n  const log = (a, b, c, d, e, f, g, h, i, k) => {\n    const time = Date.now();\n    const sequence = globalThis.ROARR.sequence++;\n\n    let context;\n    let message;\n\n    if (typeof a === 'string') {\n      context = {\n        ...getFirstParentDomainContext(),\n        ...parentContext || {},\n      };\n      // eslint-disable-next-line id-length, object-property-newline\n      const {...args} = {a, b, c, d, e, f, g, h, i, k};\n      const values = Object.keys(args).map((key) => {\n        return args[key];\n      });\n      // eslint-disable-next-line unicorn/no-reduce\n      const hasOnlyOneParameterValued = 1 === values.reduce((accumulator, value) => {\n        // eslint-disable-next-line no-return-assign, no-param-reassign\n        return accumulator += typeof value === 'undefined' ? 0 : 1;\n      }, 0);\n      message = hasOnlyOneParameterValued ? sprintf('%s', a) : sprintf(a, b, c, d, e, f, g, h, i, k);\n    } else {\n      if (typeof b !== 'string') {\n        throw new TypeError('Message must be a string.');\n      }\n\n      context = JSON.parse(stringify({\n        ...getFirstParentDomainContext(),\n        ...parentContext || {},\n        ...a,\n      }));\n\n      message = sprintf(b, c, d, e, f, g, h, i, k);\n    }\n\n    onMessage({\n      context,\n      message,\n      sequence,\n      time,\n      version: '1.0.0',\n    });\n  };\n\n  log.child = (context: TranslateMessageFunctionType | MessageContextType): LoggerType => {\n    if (typeof context === 'function') {\n      return createLogger((message) => {\n        if (typeof context !== 'function') {\n          throw new TypeError('Unexpected state.');\n        }\n        onMessage(context(message));\n      }, parentContext);\n    }\n\n    return createLogger(onMessage, {\n      ...getFirstParentDomainContext(),\n      ...parentContext,\n      ...context,\n    });\n  };\n\n  log.getContext = (): MessageContextType => {\n    return {\n      ...getFirstParentDomainContext(),\n      ...parentContext || {},\n    };\n  };\n\n  log.adopt = async (routine, context) => {\n    if (!domain) {\n      return routine();\n    }\n\n    const adoptedDomain = domain.create();\n\n    return adoptedDomain\n      .run(() => {\n        // $FlowFixMe\n        adoptedDomain.roarr = {\n          context: {\n            ...getParentDomainContext(),\n            ...context,\n          },\n        };\n\n        return routine();\n      });\n  };\n\n  for (const logLevel of Object.keys(logLevels)) {\n    // eslint-disable-next-line id-length, unicorn/prevent-abbreviations\n    log[logLevel] = (a, b, c, d, e, f, g, h, i, k) => {\n      return log.child({\n        logLevel: logLevels[logLevel],\n      })(a, b, c, d, e, f, g, h, i, k);\n    };\n  }\n\n  // @see https://github.com/facebook/flow/issues/6705\n  // $FlowFixMe\n  return log;\n};\n\nexport default createLogger;\n"]},"metadata":{},"sourceType":"script"}